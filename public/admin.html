<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gate Proxy Administration</title>
    <link rel="stylesheet" href="https://unpkg.com/open-props@1.6.14" />
    <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
      integrity="sha384-z/8ueatf01V4zGEnfe7jyL+9/TQc0tisuxGDdKek7m6eGbQIbEvhCJgYblrBa8Jv"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/gp-assets/css/app.css" />
  </head>
  <body>
    <div class="admin-shell">
      <aside class="menu sidebar">
        <div class="brand">
          <div class="brand-badge">GP</div>
          <div class="brand-copy">
            <h1>Gate Proxy</h1>
            <p>Administration Console</p>
          </div>
        </div>
        <nav class="nav-group">
          <p class="menu-label">Overview</p>
          <ul class="menu-list nav-list">
            <li><a class="nav-link is-active" data-view="dashboard" href="#" role="button">Dashboard</a></li>
            <li><a class="nav-link" data-view="settings" href="#" role="button">Settings</a></li>
          </ul>
          <p class="menu-label">Access</p>
          <ul class="menu-list nav-list">
            <li><a class="nav-link" data-view="resources" href="#" role="button">Resources</a></li>
            <li><a class="nav-link" data-view="users" href="#" role="button">Users</a></li>
          </ul>
        </nav>
        <div class="sidebar-foot">
          <p class="sidebar-foot-note">Secure • Observable • Auditable</p>
        </div>
      </aside>

      <main class="workspace">
        <header class="workspace-header">
          <div>
            <h2>Control Center</h2>
            <p>Monitor and orchestrate every facet of your GateProxy deployment.</p>
          </div>
          <div id="alert" class="notification is-hidden" role="alert"></div>
        </header>

        <div class="workspace-body">
          <section id="view-dashboard" class="admin-view is-active">
            <article class="panel">
              <header class="panel-header">
                <div>
                  <h3>Appliance Status</h3>
                  <p>Real-time insights on connectivity, certificates, and resources.</p>
                </div>
              </header>
              <div id="status-cards" class="status-grid"></div>
            </article>

            <article class="panel">
              <header class="panel-header">
                <div>
                  <h3>Setup Automation (Optional)</h3>
                  <p>Optional scripts to configure certificate infrastructure. Domain controller schema is configured during initial setup.</p>
                </div>
              </header>

              <div class="script-grid">
                <article class="script-card">
                  <header>
                    <h4>Certificate Authority Configuration <span class="badge badge-neutral">Optional</span></h4>
                    <p>Prepare AD CS for automatic certificate issuance and enrollment. This is optional - GateProxy works without it.</p>
                  </header>
                  <div class="script-actions">
                    <a href="/share/configure-certificate-server.zip" class="button is-link" download>
                      <span aria-hidden="true">⬇</span>
                      <span>configure-certificate-server.zip</span>
                    </a>
                    <p class="help">Includes auto-elevating <code>.bat</code> and PowerShell scripts.</p>
                  </div>
                  <ol class="script-steps">
                    <li>Download and extract on the enterprise CA host.</li>
                    <li>Execute <code>configure-certificate-server.bat</code> (auto-elevates) or run the PowerShell script.</li>
                    <li>Follow prompts to install AD CS roles/features and publish templates.</li>
                    <li>GateProxy will discover the CA and request certificates automatically.</li>
                  </ol>
                </article>
              </div>

              <div class="callout warning">
                <h4>Operational notes</h4>
                <ul>
                  <li>SSL certificate and certificate authority setup are <strong>optional</strong>. GateProxy will work without them.</li>
                  <li>Run scripts with appropriate elevated privileges on target servers.</li>
                  <li>Ensure Active Directory and required Windows roles are already installed.</li>
                  <li><code>.bat</code> files auto-elevate; PowerShell scripts remain available for manual execution.</li>
                </ul>
              </div>
            </article>
          </section>

          <section id="view-settings" class="admin-view">
            <article class="panel">
              <header class="panel-header">
                <div>
                  <h3>Configuration</h3>
                  <p>Define exposure, authentication posture, and administrative boundaries.</p>
                </div>
              </header>

              <form id="settings-form" class="settings-form">
                <div class="settings-group">
                  <h4>Site</h4>
                  <div class="field-grid">
                    <label>
                      <span>Public Base URL</span>
                      <input name="publicBaseUrl" placeholder="https://gateway.example.com" />
                    </label>
                    <label>
                      <span>Session Hours</span>
                      <input name="sessionHours" type="number" min="1" max="72" />
                    </label>
                    <label class="toggle">
                      <input type="checkbox" name="enableOtp" />
                      <span>Enable OTP</span>
                    </label>
                    <label class="toggle">
                      <input type="checkbox" name="enableWebAuthn" />
                      <span>Require WebAuthn</span>
                    </label>
                  </div>
                </div>

                <div class="settings-group">
                  <h4>Admin Portal Exposure</h4>
                  <div class="callout neutral">
                    <label class="toggle">
                      <input type="checkbox" name="exposeToInternet" id="exposeToInternet" />
                      <span>Expose the admin portal via Cloudflare tunnel</span>
                    </label>
                    <p>If disabled, access is limited to localhost, internal IP, or the server hostname.</p>
                  </div>
                </div>

                <div class="settings-group">
                  <h4>LDAP Connection</h4>
                  <div class="field-grid">
                    <label>
                      <span>LDAP Port</span>
                      <input name="ldapPort" type="number" placeholder="636" />
                      <small>636 for LDAPS (secure), 389 for LDAP (non-secure)</small>
                    </label>
                    <label class="toggle">
                      <input type="checkbox" name="useLdaps" id="useLdaps" />
                      <span>Use secure LDAPS</span>
                    </label>
                  </div>
                  <p class="help">Auto-detected during setup. You can manually configure if needed. LDAPS is recommended for production.</p>
                </div>

                <div class="settings-group">
                  <h4>Admin Group DNs</h4>
                  <div class="group-selector">
                    <div class="selector-controls">
                      <select id="admin-group-select">
                        <option value="">Search for a group...</option>
                      </select>
                      <button class="button is-link" type="button" id="admin-group-add">Add</button>
                    </div>
                    <input type="text" id="admin-group-search" placeholder="Type to search groups..." />
                    <div id="admin-groups-list" class="chip-collection"></div>
                    <input type="hidden" name="adminGroupDns" id="adminGroupDns" />
                  </div>
                </div>

                <footer class="form-actions">
                  <button class="button is-link" type="submit">Save settings</button>
                </footer>
              </form>

              <div class="divider"></div>

              <section class="integrations">
                <div class="integration-card">
                  <header>
                    <h4>Cloudflare Tunnel</h4>
                    <p>Tunnel is automatically managed - connects to existing or creates new tunnel.</p>
                  </header>
                  <div id="tunnel-status-container">
                    <p class="integration-status">Status: <span id="tunnel-status">Checking...</span></p>
                    <div id="tunnel-details" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
                      <div id="tunnel-auth-status"></div>
                      <div id="tunnel-config-status"></div>
                      <div id="tunnel-running-status"></div>
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                    <button class="button is-link" id="repair-tunnel-button" style="display: none;">Repair tunnel</button>
                    <button class="button is-outline" id="export-cloudflared-cert-button">Export Cert</button>
                    <button class="button is-outline" id="import-cloudflared-cert-button">Import Cert</button>
                    <input type="file" id="import-cloudflared-cert-file" accept=".pem,.txt" style="display: none;" />
                  </div>
                </div>

                <div class="integration-card">
                  <header>
                    <h4>Certificate Lifecycle <span class="badge badge-neutral">Optional</span></h4>
                    <p>Automate enrollment from your enterprise CA. SSL certificates are optional - GateProxy works without them.</p>
                  </header>
                  <ul class="cert-status">
                    <li><strong>Certificate Status:</strong> <span id="cert-status-text">Checking...</span></li>
                    <li><strong>CA Server:</strong> <span id="cert-ca-text">-</span></li>
                    <li><strong>Internal Hostname:</strong> <span id="cert-hostname-text">-</span></li>
                  </ul>
                  <button class="button is-link" id="request-certificate-button">Request certificate</button>
                  <p class="help">SSL certificates are optional. This feature requires the certificate server to be configured and reachable.</p>
                </div>

                <div class="integration-card">
                  <header>
                    <h4>Settings Portability</h4>
                    <p>Move configuration between environments with a single click.</p>
                  </header>
                  <div class="button-row">
                    <button class="button is-outline" id="export-settings-button">⬇ Export ZIP</button>
                    <button class="button is-outline" id="import-settings-button">⬆ Import ZIP</button>
                  </div>
                  <p class="help">Export creates a ZIP file with settings and Cloudflared certificate. Passwords and secrets stay encrypted and are not exported.</p>
                  <input type="file" id="import-settings-file" accept=".zip" hidden />
                </div>
              </section>
            </article>
          </section>

          <section id="view-resources" class="admin-view">
            <article class="panel">
              <header class="panel-header">
                <div>
                  <h3>Protected Resources</h3>
                  <p>Curate application access for your workforce.</p>
                </div>
                <button class="button is-link" id="resource-add">Add resource</button>
              </header>
              <div id="resource-table" class="data-table"></div>
            </article>
          </section>

          <section id="view-users" class="admin-view">
            <article class="panel">
              <header class="panel-header">
                <div>
                  <h3>Directory Users</h3>
                  <p>Insight and control for every managed identity.</p>
                </div>
                <div class="user-toolbar">
                  <button class="button is-link" id="add-user-button">＋ Add user</button>
                  <div class="search-input">
                    <input id="user-query" placeholder="Search by name or SAM" />
                    <button class="button is-outline" id="user-search">Search</button>
                  </div>
                </div>
              </header>
              <div id="user-table" class="data-table"></div>
            </article>
          </section>
        </div>
      </main>
    </div>

    <div class="modal" id="user-modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title" id="user-modal-title">User</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <form id="user-form" class="modal-form">
            <label>
              <span>Email</span>
              <input name="mail" type="email" placeholder="user@example.com" />
            </label>
            <label>
              <span>Phone</span>
              <input name="telephoneNumber" placeholder="Optional" />
            </label>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-link" id="user-save">Save</button>
          <button class="button is-outline" id="user-reset-webauthn">Clear WebAuthn</button>
          <button class="button is-outline" id="user-unlock">Unlock</button>
          <button class="button is-danger" id="user-disable">Disable</button>
        </footer>
      </div>
    </div>

    <div class="modal" id="add-user-modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Add New User</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <form id="add-user-form" class="modal-form">
            <label>
              <span>SAM Account Name <strong>*</strong></span>
              <input name="sAMAccountName" required placeholder="username" />
              <small>The login username (required)</small>
            </label>
            <label>
              <span>Display Name <strong>*</strong></span>
              <input name="displayName" required placeholder="Full name" />
              <small>The user's full display name (required)</small>
            </label>
            <div class="dual-input">
              <label>
                <span>First Name</span>
                <input name="givenName" placeholder="First" />
              </label>
              <label>
                <span>Last Name</span>
                <input name="sn" placeholder="Last" />
              </label>
            </div>
            <label>
              <span>Email</span>
              <input type="email" name="mail" placeholder="user@example.com" />
            </label>
            <label>
              <span>Password <strong>*</strong></span>
              <input type="password" name="password" required placeholder="Enter password" />
              <small>Initial password for the user (required)</small>
            </label>
            <label class="toggle">
              <input type="checkbox" name="enabled" checked />
              <span>Account enabled (user can log in immediately)</span>
            </label>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-link" id="add-user-save">Create user</button>
          <button class="button is-outline" id="add-user-cancel">Cancel</button>
        </footer>
      </div>
    </div>

    <div class="modal" id="resource-modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Add Protected Resource</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <form id="resource-form" class="modal-form">
            <label>
              <span>Resource Name</span>
              <input name="name" type="text" placeholder="e.g. Sora Toolbox" required />
            </label>
            <label>
              <span>Target URL</span>
              <input name="target_url" type="url" placeholder="http://10.0.0.5:9443" required />
              <small>The internal URL of the resource to proxy.</small>
            </label>
            <label>
              <span>Description</span>
              <textarea name="description" placeholder="Optional description"></textarea>
            </label>
            <label>
              <span>Icon URL</span>
              <input name="icon" type="url" placeholder="https://example.com/icon.png" />
              <small>Optional icon URL for the landing page.</small>
            </label>
            <div class="group-selector">
              <span>Allowed Groups</span>
              <div class="selector-controls">
                <select id="resource-group-select">
                  <option value="">Search for a group...</option>
                </select>
                <button class="button is-link" type="button" id="resource-group-add">Add</button>
              </div>
              <input type="text" id="resource-group-search" placeholder="Type to search groups..." />
              <p class="help">Leave empty to allow any authenticated user.</p>
              <div id="resource-groups-list" class="chip-collection"></div>
              <input type="hidden" name="allowed_groups" id="resource-allowed-groups" />
            </div>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-link" id="resource-save">Add resource</button>
          <button class="button is-outline" id="resource-cancel">Cancel</button>
        </footer>
      </div>
    </div>

    <script type="module" src="/gp-assets/js/admin.js"></script>
  </body>
</html>

