<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Linux Gate Proxy Setup</title>
    <link rel="stylesheet" href="/assets/css/bulma.min.css" />
    <link rel="stylesheet" href="/assets/css/app.css" />
  </head>
  <body class="has-background-light">
    <section class="section">
      <div class="container">
        <div class="box">
          <h1 class="title">Linux Gate Proxy Setup</h1>
          <p class="subtitle">Guided configuration wizard</p>
                    <div id="setup-progress" class="steps has-content-centered">
            <div class="step-item is-active" data-step="1">
              <div class="step-marker">1</div>
              <div class="step-details">
                <p class="step-title">Prerequisites</p>
              </div>
            </div>
            <div class="step-item" data-step="2">
              <div class="step-marker">2</div>
              <div class="step-details">
                <p class="step-title">Active Directory</p>
              </div>
            </div>
            <div class="step-item" data-step="3">
              <div class="step-marker">3</div>
              <div class="step-details">
                <p class="step-title">Site</p>
              </div>
            </div>
            <div class="step-item" data-step="4">
              <div class="step-marker">4</div>
              <div class="step-details">
                <p class="step-title">Setup Scripts</p>
              </div>
            </div>
            <div class="step-item" data-step="5">
              <div class="step-marker">5</div>
              <div class="step-details">
                <p class="step-title">Cloudflare</p>
              </div>
            </div>
            <div class="step-item" data-step="6">
              <div class="step-marker">6</div>
              <div class="step-details">
                <p class="step-title">Resources</p>
              </div>
            </div>
            <div class="step-item" data-step="7">
              <div class="step-marker">7</div>
              <div class="step-details">
                <p class="step-title">Finish</p>
              </div>
            </div>
          </div>

          <div id="alert" class="notification is-hidden"></div>

          <div id="step-contents">
            <div id="step-1" class="setup-step is-active">
              <h2 class="title is-4">Install Prerequisites</h2>
              <p>Before continuing, ensure the host has Cloudflare Tunnel binary installed.</p>
              <div class="columns mt-3">
                <div class="column">
                  <article class="message" id="prereq-cloudflared">
                    <div class="message-header">
                      <p>Cloudflared</p>
                    </div>
                    <div class="message-body">
                      <p class="prereq-status-text">Checking...</p>
                      <p class="is-size-7">Used for device-login to Cloudflare.</p>
                    </div>
                  </article>
                </div>
              </div>
              <div class="content">
                <p>Run the helper script to install prerequisites:</p>
                <pre><code id="prereq-script">bash scripts/install-prereqs.sh</code></pre>
              </div>
              <div class="buttons">
                <button class="button" id="prereq-refresh" type="button">Re-check</button>
                <button class="button is-link" id="prereq-continue" type="button">Continue</button>
              </div>
            </div>
            <form id="step-2" class="setup-step">
              <h2 class="title is-4">Active Directory Connection</h2>
              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">Domain FQDN</label>
                    <div class="control has-icons-left">
                      <input class="input" name="domain" required placeholder="example.corp" />
                      <span class="icon is-small is-left">
                        <i class="fas fa-globe"></i>
                      </span>
                    </div>
                  </div>
                  <div class="field">
                    <label class="label">LDAP Host</label>
                    <input class="input" name="ldapHost" required placeholder="dc01.example.corp" />
                  </div>
                  <div class="field">
                    <label class="label">Base DN</label>
                    <input class="input" name="baseDn" required placeholder="DC=example,DC=corp" />
                  </div>
                  <div class="field">
                    <label class="label">Service Account (UPN)</label>
                    <input class="input" name="lookupUser" required placeholder="gateproxy@example.corp" />
                  </div>
                  <div class="field">
                    <label class="label">Service Account Password</label>
                    <input class="input" name="password" type="password" required />
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="label">LDAP Port</label>
                    <input class="input" name="ldapPort" type="number" value="636" />
                  </div>
                  <div class="field">
                    <label class="checkbox">
                      <input type="checkbox" name="useLdaps" checked />
                      Use LDAPS (recommended)
                    </label>
                  </div>
                  <div class="field">
                    <label class="label">Session Attribute</label>
                    <input class="input" name="sessionAttribute" value="gateProxySession" />
                  </div>
                  <div class="field">
                    <label class="label">WebAuthn Attribute</label>
                    <input class="input" name="webAuthnAttribute" value="gateProxyWebAuthn" />
                  </div>

                  <div class="field">
                    <label class="label">Admin Access</label>
                    <article class="message is-info">
                      <div class="message-body">
                        <p><strong>Domain Admins have admin access by default.</strong></p>
                        <p class="is-size-7 mt-2">You can configure additional admin groups after setup is complete in the admin portal.</p>
                      </div>
                    </article>
                  </div>
                </div>
              </div>
              <div class="field is-grouped is-justify-content-flex-end">
                <div class="control">
                  <button class="button is-link" type="submit">Test &amp; Continue</button>
                </div>
              </div>
            </form>
            <form id="step-3" class="setup-step">
              <h2 class="title is-4">Site Configuration</h2>
              <div class="columns">
                <div class="column">
                  <div class="field">
                    <label class="label">Listen Address</label>
                    <input class="input" name="listenAddress" value="127.0.0.1" />
                  </div>
                  <div class="field">
                    <label class="label">Listen Port</label>
                    <input class="input" name="listenPort" type="number" value="5000" />
                  </div>
                  <div class="field">
                    <label class="label">Public Base URL</label>
                    <input class="input" name="publicBaseUrl" placeholder="https://portal.example.com" />
                  </div>
                  <div class="field">
                    <label class="label">Session Duration (hours)</label>
                    <input class="input" name="sessionHours" type="number" value="8" />
                  </div>
                </div>
                <div class="column">
                  <div class="field">
                    <label class="checkbox">
                      <input type="checkbox" name="enableOtp" checked />
                      Enable OTP fallback
                    </label>
                  </div>
                  <div class="field">
                    <label class="checkbox">
                      <input type="checkbox" name="enableWebAuthn" checked />
                      Enforce WebAuthn second factor
                    </label>
                  </div>
                  <div class="box has-background-light">
                    <p class="has-text-weight-semibold">SMTP Settings</p>
                    <div class="field">
                      <label class="label">SMTP Host</label>
                      <input class="input" name="smtpHost" />
                    </div>
                    <div class="field">
                      <label class="label">SMTP Port</label>
                      <input class="input" name="smtpPort" type="number" value="587" />
                    </div>
                    <div class="field">
                      <label class="checkbox">
                        <input type="checkbox" name="smtpSecure" />
                        Use TLS
                      </label>
                    </div>
                    <div class="field">
                      <label class="label">SMTP Username</label>
                      <input class="input" name="smtpUsername" />
                    </div>
                    <div class="field">
                      <label class="label">SMTP Password</label>
                      <input class="input" name="smtpPassword" type="password" />
                    </div>
                    <div class="field">
                      <label class="label">From Address</label>
                      <input class="input" name="smtpFrom" />
                    </div>
                    <div class="field">
                      <label class="label">Reply-To (optional)</label>
                      <input class="input" name="smtpReplyTo" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="field is-grouped">
                <div class="control">
                  <button class="button" data-action="prev">Back</button>
                </div>
                <div class="control">
                  <button class="button is-link" type="submit">Save &amp; Continue</button>
                </div>
              </div>
            </form>
            <div id="step-4" class="setup-step">
              <h2 class="title is-4">Setup Scripts</h2>
              <p class="mb-4">Download and run these helper scripts on your domain controller and certificate server to complete the integration.</p>
              
              <div class="columns mt-5">
                <div class="column">
                  <div class="box">
                    <h3 class="title is-5 mb-4">1. Domain Controller Setup</h3>
                    <p class="mb-4">Configures your domain controller for Linux Gate Proxy integration. Creates service account, firewall rules, and DNS records.</p>
                    
                    <div class="field">
                      <label class="label">Download Scripts:</label>
                      <div class="buttons">
                        <a href="/share/configure-domain-controller.bat" class="button is-link is-outlined" download>
                          <span class="icon"><i class="fas fa-download"></i></span>
                          <span>configure-domain-controller.bat</span>
                        </a>
                        <a href="/share/configure-domain-controller.ps1" class="button is-link is-outlined" download>
                          <span class="icon"><i class="fas fa-download"></i></span>
                          <span>configure-domain-controller.ps1</span>
                        </a>
                      </div>
                    </div>

                    <div class="message is-info mt-4">
                      <div class="message-body">
                        <p class="has-text-weight-semibold mb-2">How to Run:</p>
                        <ol class="ml-4" style="list-style-type: decimal;">
                          <li class="mb-2">Download both files to your domain controller</li>
                          <li class="mb-2">Double-click <code>configure-domain-controller.bat</code></li>
                          <li class="mb-2">The script will automatically request administrator privileges</li>
                          <li class="mb-2">When prompted, enter the tunnel hostname (e.g., tunnel.yourdomain.com)</li>
                          <li class="mb-2">Enter the Gate Proxy host IP address</li>
                          <li>Enter a password for the service account when prompted</li>
                        </ol>
                        <p class="mt-3"><strong>Note:</strong> The .bat file automatically runs as administrator. You can also run the .ps1 file directly if you prefer.</p>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="column">
                  <div class="box">
                    <h3 class="title is-5 mb-4">2. Certificate Server Setup</h3>
                    <p class="mb-4">Configures your certificate authority to issue WebAuthn certificates for Gate Proxy.</p>
                    
                    <div class="field">
                      <label class="label">Download Scripts:</label>
                      <div class="buttons">
                        <a href="/share/configure-certificate-server.bat" class="button is-link is-outlined" download>
                          <span class="icon"><i class="fas fa-download"></i></span>
                          <span>configure-certificate-server.bat</span>
                        </a>
                        <a href="/share/configure-certificate-server.ps1" class="button is-link is-outlined" download>
                          <span class="icon"><i class="fas fa-download"></i></span>
                          <span>configure-certificate-server.ps1</span>
                        </a>
                      </div>
                    </div>

                    <div class="message is-info mt-4">
                      <div class="message-body">
                        <p class="has-text-weight-semibold mb-2">How to Run:</p>
                        <ol class="ml-4" style="list-style-type: decimal;">
                          <li class="mb-2">Download both files to your certificate server</li>
                          <li class="mb-2">Double-click <code>configure-certificate-server.bat</code></li>
                          <li class="mb-2">The script will automatically request administrator privileges</li>
                          <li class="mb-2">When prompted, enter the external hostname (e.g., sora2jailbreak.com)</li>
                          <li>The script will create a certificate template and submit a certificate request</li>
                        </ol>
                        <p class="mt-3"><strong>Note:</strong> The .bat file automatically runs as administrator. You can also run the .ps1 file directly if you prefer.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <article class="message is-warning mt-5">
                <div class="message-header">
                  <p>Important Notes</p>
                </div>
                <div class="message-body">
                  <ul class="ml-4">
                    <li>Replace <code>localhost</code> in URLs above with your server's IP address when accessing from other machines</li>
                    <li>Both scripts require Active Directory and appropriate server roles to be installed</li>
                    <li>Ensure your account has the necessary permissions (Domain Admin for DC, CA Admin for Certificate Server)</li>
                    <li>The scripts will prompt for required information during execution</li>
                  </ul>
                </div>
              </article>

              <div class="field is-grouped mt-5">
                <div class="control">
                  <button class="button" data-action="prev">Back</button>
                </div>
                <div class="control">
                  <button class="button is-link" data-action="next">Continue</button>
                </div>
              </div>
            </div>
            <div id="step-5" class="setup-step">
              <h2 class="title is-4">Cloudflare Authentication</h2>
              <p>Authenticate with Cloudflare to authorize this application to manage tunnels on your account.</p>
              <div class="notification is-info is-light">
                <strong>Note:</strong> When you click the login link, Cloudflare will ask you to select a zone for authorization. This is just for OAuth authorization purposes - it does <strong>not</strong> create a tunnel or affect your existing tunnels. You can select any zone you manage. After authentication, you'll be able to reuse existing tunnels or create new ones.
              </div>
              <div id="cloudflare-login" class="box">
                <button class="button is-link" id="cloudflare-start">Generate Login Link</button>
                <div id="cloudflare-status" class="mt-4"></div>
              </div>
              <div class="field is-grouped">
                <div class="control">
                  <button class="button" data-action="prev">Back</button>
                </div>
                <div class="control">
                  <button class="button is-link" id="cloudflare-next">Continue</button>
                </div>
              </div>
            </div>
            <form id="step-6" class="setup-step">
              <h2 class="title is-4">Protected Resources</h2>
              <p>Add internal services that should be exposed after authentication. Configure at least one destination.</p>
              <div class="field">
                <label class="label">Primary Target URL</label>
                <input class="input" name="targetHost" placeholder="http://127.0.0.1:5600" required />
              </div>
              <div id="resource-list"></div>
              <div class="buttons mt-3">
                <button class="button is-small" type="button" id="add-resource">Add Resource</button>
              </div>
              <div class="field is-grouped">
                <div class="control">
                  <button class="button" data-action="prev">Back</button>
                </div>
                <div class="control">
                  <button class="button is-link" type="submit">Save Resources</button>
                </div>
              </div>
            </form>
            <div id="step-7" class="setup-step">
              <h2 class="title is-4">Setup Complete</h2>
              <p>Review the summary and launch the appliance.</p>
              <div id="summary"></div>
              <div class="buttons is-right mt-4">
                <button class="button is-success" id="finish-setup">Complete Setup</button>
              </div>
            </div>
          </div>
<script src="https://kit.fontawesome.com/a2e0e9b1ef.js" crossorigin="anonymous"></script>
    <script type="module" src="/assets/js/setup.js"></script>
  </body>
</html>

