<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gate Proxy Setup</title>
    <link rel="stylesheet" href="https://unpkg.com/open-props@1.6.14" />
    <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
      integrity="sha384-z/8ueatf01V4zGEnfe7jyL+9/TQc0tisuxGDdKek7m6eGbQIbEvhCJgYblrBa8Jv"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/gp-assets/css/app.css" />
  </head>
  <body class="setup-body">
    <main class="setup-shell">
      <header class="setup-hero">
        <div class="hero-badge">GP</div>
        <div class="hero-copy">
          <h1>Gate Proxy Setup</h1>
          <p>We will walk through tiny steps so everything feels easy.</p>
        </div>
      </header>

      <div class="progress-strip">
        <div class="progress-track"><div class="progress-fill" id="step-progress-fill"></div></div>
        <span class="progress-text" id="step-progress-text">Step 1 of 7</span>
      </div>

      <section id="alert" class="notification is-hidden"></section>

      <section id="step-contents" class="step-stack">
        <section id="step-1" class="setup-step is-active" data-step-index="1">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Pick how you want to start</h2>
            <p>Already have another Gate Proxy running? Upload its bundle, or keep going to set things up by hand.</p>
          </header>

          <div class="card-grid">
            <article class="wizard-card highlight">
              <h3>Use a bundle</h3>
              <p>Choose the ZIP we exported earlier. We copy every setting along with your Cloudflare login ticket.</p>
              <div class="card-actions">
                <button class="primary" type="button" id="setup-import-button">Upload configuration ZIP</button>
                <input type="file" id="setup-import-file" accept=".zip" hidden />
              </div>
              <p class="muted small">We look for <code>gate-proxy-config.zip</code>.</p>
            </article>

            <article class="wizard-card">
              <h3>Set up by hand</h3>
              <p>We just need Cloudflared installed on this server. It lets Gate Proxy talk to Cloudflare.</p>
              <div class="status-card" id="prereq-cloudflared" data-state="checking">
                <span class="status-dot" aria-hidden="true"></span>
                <div>
                  <p class="status-title">Cloudflared</p>
                  <p class="prereq-status-text">Checking…</p>
                </div>
              </div>
              <p class="muted">If we can't find it, run this command:</p>
              <pre class="code-block"><code id="prereq-script">bash scripts/install-prereqs.sh</code></pre>
              <div class="card-actions">
                <button class="ghost" type="button" id="prereq-refresh">Check again</button>
                <button class="primary" type="button" id="prereq-continue">Looks good</button>
              </div>
            </article>
          </div>
        </section>

        <form id="step-2" class="setup-step" data-step-index="2">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Tell us about your domain</h2>
            <p>These details help Gate Proxy find your directory.</p>
          </header>

          <div class="step-body two-column">
            <fieldset>
              <legend>Domain details</legend>
              <div class="domain-basics-simple">
                <label>
                  <span>LDAP host</span>
                  <div style="display: flex; gap: 0.5rem;">
                    <select id="ldapHostSelect" style="flex: 1; min-width: 0;">
                      <option value="">Choose a discovered server...</option>
                    </select>
                    <span style="align-self: center; color: var(--text-muted);">or</span>
                    <input name="ldapHost" required placeholder="dc01.example.corp or IP address" id="ldapHostInput" style="flex: 2; min-width: 0;" />
                  </div>
                  <small class="muted small" id="ldapHostHint">Enter hostname or IP address</small>
                </label>
                <div id="ldapConnectionStatus" class="connection-status" style="display: none;">
                  <span class="status-indicator"></span>
                  <span class="status-text">Connecting...</span>
                </div>
                <button type="button" class="advanced-toggle" id="domainAdvancedToggle">
                  <span>Advanced</span>
                  <span class="toggle-icon">▼</span>
                </button>
              </div>
              <div class="domain-basics-advanced" id="domainAdvanced" style="display: none;">
                <label>
                  <span>Domain name</span>
                  <input name="domain" placeholder="example.corp" id="domainInput" />
                  <small class="muted small">Auto-filled from LDAP host</small>
                </label>
                <label>
                  <span>Base DN</span>
                  <input name="baseDn" placeholder="DC=example,DC=corp" id="baseDnInput" />
                  <small class="muted small">Auto-filled from LDAP host</small>
                </label>
                <label>
                  <span>LDAPS port</span>
                  <input name="ldapsPort" type="number" value="636" placeholder="636" />
                  <small class="muted small">Port for secure LDAPS connections (default: 636)</small>
                </label>
                <label>
                  <span>LDAP port</span>
                  <input name="ldapPort" type="number" value="389" placeholder="389" />
                  <small class="muted small">Port for non-secure LDAP connections (default: 389)</small>
                </label>
              </div>
            </fieldset>

            <fieldset>
              <legend>Service account</legend>
                <label>
                  <span>Service account</span>
                  <input name="lookupUser" required placeholder="username, username@domain.com, or domain\username" />
                  <small class="muted small">Enter username in any format (plain username, UPN, or domain\username)</small>
                </label>
              <label>
                <span>Password</span>
                <input name="password" type="password" required />
              </label>
              <div class="info-card">
                <p class="info-title">Who can manage Gate Proxy?</p>
                <p>We automatically allow the <strong>Domain Admins</strong> group. You can add more later in the admin page.</p>
              </div>
              
              <!-- Domain Controller Configuration -->
              <div class="callout neutral dc-config-callout">
                <h4>Domain Controller Setup Required</h4>
                <p>Before testing the connection, make sure your domain controller is configured:</p>
                <ul class="dc-config-checklist">
                  <li>LDAPS (port 636) is bound to a certificate</li>
                  <li>GateProxy schema attributes are installed</li>
                </ul>
                <div class="dc-config-actions">
                  <a href="/share/configure-gateproxy-dc.zip" class="button primary dc-config-download" download>
                    <span aria-hidden="true">⬇</span>
                    <span>Download configure-gateproxy-dc.zip</span>
                  </a>
                  <span class="muted small">Run on the Schema Master as a Schema&nbsp;Admin + Domain&nbsp;Admin.</span>
                </div>
                <ol class="guide-list dc-config-steps">
                  <li>Download and extract on your <strong>Schema Master Domain Controller</strong></li>
                  <li>Right-click <code>configure-gateproxy-dc.bat</code> and select <em>Run as administrator</em></li>
                  <li>The script will automatically:
                    <ul>
                      <li>Bind an LDAPS certificate (port&nbsp;636)</li>
                      <li>Update the Active Directory schema for GateProxy</li>
                    </ul>
                  </li>
                  <li>Return here and test the connection again</li>
                </ol>
              </div>
              
              <!-- LDAPS Configuration Error Notice (shown only on error) -->
              <div id="ldapsConfigNotice" class="callout warning dc-config-error" style="display: none;">
                <h4>LDAPS Configuration Error</h4>
                <p>The connection test failed because the domain controller could not negotiate a secure LDAP session.</p>
                <p><strong>Please run the GateProxy domain controller script above, then retry the test.</strong></p>
              </div>
            </fieldset>
          </div>

          <footer class="step-footer">
            <span></span>
            <button class="primary" type="submit">Test connection</button>
          </footer>
        </form>

        <form id="step-3" class="setup-step" data-step-index="3">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Server setup</h2>
            <p>Configure how Gate Proxy listens for connections and manages sessions.</p>
          </header>

          <div class="step-body">
            <fieldset>
              <legend>Server configuration</legend>
              <label>
                <span>Listen address</span>
                <input name="listenAddress" value="0.0.0.0" placeholder="0.0.0.0" />
                <small class="muted small">0.0.0.0 listens on all network interfaces</small>
              </label>
              <label>
                <span>Listen port</span>
                <input name="listenPort" type="number" value="5000" placeholder="5000" />
                <small class="muted small">Port number for HTTP connections</small>
              </label>
              <label>
                <span>Public base URL (optional)</span>
                <input name="publicBaseUrl" placeholder="https://portal.example.com" />
                <small class="muted small">The public URL users will access Gate Proxy from</small>
              </label>
              <label>
                <span>Session time (hours)</span>
                <input name="sessionHours" type="number" value="8" placeholder="8" />
                <small class="muted small">How long users stay logged in</small>
              </label>
            </fieldset>

            <fieldset>
              <legend>Authentication options</legend>
              <label class="checkbox-row">
                <input type="checkbox" name="enableOtp" id="enableOtpCheckbox" />
                <span>Enable OTP email</span>
                <small class="muted small">Allow users to receive one-time passwords via email</small>
              </label>
              <label class="checkbox-row">
                <input type="checkbox" name="enableWebAuthn" id="enableWebAuthnCheckbox" />
                <span>Enable WebAuthn</span>
                <small class="muted small">Allow users to use security keys or biometric authentication</small>
              </label>
            </fieldset>
          </div>

          <footer class="step-footer">
            <button class="ghost" type="button" data-action="prev">Back</button>
            <button class="ghost" type="button" id="skip-server-setup">Skip (use defaults)</button>
            <button class="primary" type="submit">Save &amp; continue</button>
          </footer>
        </form>

        <form id="step-4" class="setup-step" data-step-index="4">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Email setup</h2>
            <p>Configure SMTP to send one-time passwords and notifications.</p>
          </header>

          <div class="step-body">
            <fieldset>
              <legend>SMTP server</legend>
              <label>
                <span>SMTP host</span>
                <input name="smtpHost" placeholder="smtp.example.com" />
                <small class="muted small">Your mail server hostname</small>
              </label>
              <label>
                <span>SMTP port</span>
                <input name="smtpPort" type="number" value="587" placeholder="587" />
                <small class="muted small">Usually 587 for TLS or 465 for SSL</small>
              </label>
              <label class="checkbox-row">
                <input type="checkbox" name="smtpSecure" />
                <span>Use TLS</span>
                <small class="muted small">Enable encryption for SMTP connections</small>
              </label>
            </fieldset>

            <fieldset>
              <legend>Authentication</legend>
              <label>
                <span>SMTP username</span>
                <input name="smtpUsername" placeholder="gateproxy@example.com" />
                <small class="muted small">Username for SMTP authentication</small>
              </label>
              <label>
                <span>SMTP password</span>
                <input name="smtpPassword" type="password" placeholder="••••••••" />
                <small class="muted small">Password for SMTP authentication</small>
              </label>
            </fieldset>

            <fieldset>
              <legend>Email headers</legend>
              <label>
                <span>From address</span>
                <input name="smtpFrom" placeholder="gateproxy@example.corp" />
                <small class="muted small">Sender email address for notifications</small>
              </label>
              <label>
                <span>Reply-To (optional)</span>
                <input name="smtpReplyTo" placeholder="helpdesk@example.corp" />
                <small class="muted small">Where replies to notifications should go</small>
              </label>
            </fieldset>

            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
              <button type="button" class="outline" id="test-email-connection" style="width: 100%;">
                <span>Test SMTP connection</span>
              </button>
              <div id="email-test-status" style="margin-top: 1rem; display: none;">
                <div class="connection-status">
                  <span class="status-indicator"></span>
                  <span class="status-text"></span>
                </div>
              </div>
            </div>
          </div>

          <footer class="step-footer">
            <button class="ghost" type="button" data-action="prev">Back</button>
            <button class="ghost" type="button" id="skip-email-setup">Skip (OTP will be disabled)</button>
            <button class="primary" type="submit" id="email-continue-btn">Save &amp; continue</button>
          </footer>
        </form>

        <!-- Step 4 removed - helper scripts are accessible from step 2 (Domain setup) -->

        <section id="step-5" class="setup-step" data-step-index="5">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Sign in to Cloudflare</h2>
            <p>We only need to confirm this server is allowed to reuse your tunnel.</p>
          </header>

          <div class="wizard-card">
            <p>Click the button to get a one-time login link. Cloudflare will ask you to pick any zone you manage. That pick does not change your tunnels.</p>
            <div class="card-actions">
              <button class="primary" id="cloudflare-start">Get login link</button>
            </div>
            <div id="cloudflare-status" class="cloudflare-status"></div>
          </div>

          <footer class="step-footer">
            <button class="ghost" type="button" data-action="prev">Back</button>
            <button class="primary" type="button" id="cloudflare-next">Continue</button>
          </footer>
        </section>

        <form id="step-6" class="setup-step" data-step-index="6">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>Add resources you want to protect</h2>
            <p>We start with one main target, then you can add more resources.</p>
          </header>

          <div class="step-body">
            <label>
              <span>Main target URL (optional)</span>
              <input name="targetHost" placeholder="http://127.0.0.1:5600" />
              <small class="muted small">The primary application or service you want to protect. You can configure this later in the admin panel.</small>
            </label>

            <div id="resource-list" class="resource-stack"></div>

            <button class="outline" type="button" id="add-resource">Add another resource</button>
          </div>

          <footer class="step-footer">
            <button class="ghost" type="button" data-action="prev">Back</button>
            <button class="ghost" type="button" id="skip-resources">Skip for now</button>
            <button class="primary" type="submit">Save resources</button>
          </footer>
        </form>

        <section id="step-7" class="setup-step" data-step-index="7">
          <header class="step-header">
            <span class="step-pill" data-step-label></span>
            <h2>All set!</h2>
            <p>Look over the summary, then launch Gate Proxy.</p>
          </header>

          <div id="summary" class="summary-grid"></div>

          <footer class="step-footer">
            <button class="primary" id="finish-setup">Complete setup</button>
          </footer>
        </section>
      </section>
    </main>

    <script type="module" src="/gp-assets/js/setup.js"></script>
  </body>
</html>

